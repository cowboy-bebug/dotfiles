#!/usr/bin/env bash

# Default values
out_dir=""
title=""

# Function to show usage
show_usage() {
  echo "Usage: $(basename "$0") [OPTIONS]"
  echo ""
  echo "OPTIONS:"
  echo "  -p, --path <path>    Target directory for the blog post"
  echo "                       (defaults to current directory if not specified)"
  echo "  -t, --title <title>  Title of the blog post (required)"
  echo "  -h, --help          Show this help message"
  echo ""
  echo "Examples:"
  echo "  $(basename "$0") -t \"My Blog Post\""
  echo "  $(basename "$0") --path ~/blog-dev --title \"My Blog Post\""
  echo "  $(basename "$0") -p ~/blog-dev -t \"My Blog Post\""
}

# Parse command line arguments
while [[ $# -gt 0 ]]; do
  case $1 in
  -p | --path)
    out_dir="$2"
    shift 2
    ;;
  -t | --title)
    title="$2"
    shift 2
    ;;
  -h | --help)
    show_usage
    exit 0
    ;;
  *)
    echo "Error: Unknown option '$1'"
    echo ""
    show_usage
    exit 1
    ;;
  esac
done

# Check if title is provided
if [ -z "$title" ]; then
  echo "Error: Title is required"
  echo ""
  show_usage
  exit 1
fi

# If no path specified, use current directory
if [ -z "$out_dir" ]; then
  out_dir="$(pwd)"
fi

# Expand tilde and resolve path
out_dir=$(eval echo "$out_dir")

# Check if target directory exists
if [ ! -d "$out_dir" ]; then
  echo "Error: Directory '$out_dir' does not exist"
  exit 1
fi

timestamp=$(date +"%Y%m%d%H%M")
slug=$(echo "$title" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9 ]//g' | tr ' ' '-')

file_name="${timestamp}-${slug}.md"
file_path="${out_dir}/${file_name}"

cat <<EOF >"$file_path"
---
title: "$title"
publishDate: $(gdate +"%Y-%m-%dT%H:%M:%S%:z")
tags: []
description: ""
---

# $title

Start writing your post here...
EOF

echo "Created: $file_path"

code --new-window "$out_dir" --goto "$file_path"
